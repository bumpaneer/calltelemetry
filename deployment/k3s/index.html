
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://docs.calltelemetry.com/deployment/k3s/">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.8">
    
    
      
        <title>Kubernetes - CallTelemetry</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.39b8e14a.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-153385083-2","mkdocs.org"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#k3s-cluster-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://docs.calltelemetry.com" title="CallTelemetry" class="md-header-nav__button md-logo" aria-label="CallTelemetry">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            CallTelemetry
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Kubernetes
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../changelog/" class="md-tabs__link">
      Change Log
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../licensing/" class="md-tabs__link">
      Licensing
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../cloud/" class="md-tabs__link">
      Cloud Demo
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../architecture/" class="md-tabs__link md-tabs__link--active">
        Installation Guide
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../features/policy/" class="md-tabs__link">
        Using CallTelemetry
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../apps/webhooks/" class="md-tabs__link">
        App Catalog
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../troubleshooting/logs/" class="md-tabs__link">
        Troubleshooting
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://docs.calltelemetry.com" title="CallTelemetry" class="md-nav__button md-logo" aria-label="CallTelemetry">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    CallTelemetry
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        Change Log
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../licensing/" class="md-nav__link">
        Licensing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/" class="md-nav__link">
        Cloud Demo
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
      
      <label class="md-nav__link" for="nav-4">
        Installation Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Installation Guide" data-md-level="1">
        <label class="md-nav__title" for="nav-4">
          <span class="md-nav__icon md-icon"></span>
          Installation Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2" checked>
      
      <label class="md-nav__link" for="nav-4-2">
        Platform
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Platform" data-md-level="2">
        <label class="md-nav__title" for="nav-4-2">
          <span class="md-nav__icon md-icon"></span>
          Platform
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../choices/" class="md-nav__link">
        Platform Choices
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../sizing/" class="md-nav__link">
        Sizing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ova/" class="md-nav__link">
        OVA Appliance
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Kubernetes
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ip-addressing" class="md-nav__link">
    IP Addressing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-3-or-more-calltelemetry-cluster-ovas" class="md-nav__link">
    Deploy 3 or more CallTelemetry Cluster OVAs
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3" >
      
      <label class="md-nav__link" for="nav-4-3">
        Integration to Callmanager
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Integration to Callmanager" data-md-level="2">
        <label class="md-nav__title" for="nav-4-3">
          <span class="md-nav__icon md-icon"></span>
          Integration to Callmanager
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/curri/" class="md-nav__link">
        Call Control
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/cdr/" class="md-nav__link">
        CDR
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/mcid/" class="md-nav__link">
        MCID Spam Tags
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" >
      
      <label class="md-nav__link" for="nav-5">
        Using CallTelemetry
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Using CallTelemetry" data-md-level="1">
        <label class="md-nav__title" for="nav-5">
          <span class="md-nav__icon md-icon"></span>
          Using CallTelemetry
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/policy/" class="md-nav__link">
        Policies
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/mcid/" class="md-nav__link">
        MCID Blocking
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/apps/" class="md-nav__link">
        Whare are Apps?
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/organizations/" class="md-nav__link">
        Organizations
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" >
      
      <label class="md-nav__link" for="nav-6">
        App Catalog
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="App Catalog" data-md-level="1">
        <label class="md-nav__title" for="nav-6">
          <span class="md-nav__icon md-icon"></span>
          App Catalog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../apps/webhooks/" class="md-nav__link">
        Catalog
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" >
      
      <label class="md-nav__link" for="nav-7">
        Troubleshooting
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Troubleshooting" data-md-level="1">
        <label class="md-nav__title" for="nav-7">
          <span class="md-nav__icon md-icon"></span>
          Troubleshooting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/logs/" class="md-nav__link">
        Logs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/cdr/" class="md-nav__link">
        CDR
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ip-addressing" class="md-nav__link">
    IP Addressing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-3-or-more-calltelemetry-cluster-ovas" class="md-nav__link">
    Deploy 3 or more CallTelemetry Cluster OVAs
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="k3s-cluster-guide">K3S Cluster Guide</h1>
<p>Although it is a long page, the entire deployment is only about 30 minutes.</p>
<h2 id="architecture">Architecture</h2>
<p><img alt="k3s" src="../k3s-architecture.png" />  </p>
<h2 id="ip-addressing">IP Addressing</h2>
<p><img alt="k3s-ips" src="../k3s-ips.png" />  </p>
<h2 id="deploy-3-or-more-calltelemetry-cluster-ovas">Deploy 3 or more CallTelemetry Cluster OVAs</h2>
<p><a href="https://storage.googleapis.com/ct_ovas/CT-cluster-040-centos-8.3-x86_64.ova">Download CentOS 8.3 OVA File - 900MB</a></p>
<p>The OVA includes a couple utilities - helm, kubectl, k9s, and saves you a little time "building" the OS. It's prebuilt from CentOS 8.3 with all updates applied.
You can install this on ANY linux distro, but the support required to do so is beyond my time. </p>
<details class="note"><summary>I want to install CentOS myself - what's missing?</summary><h1 id="enable-snaps">enable snaps</h1>
<p>yum install -y epel-release
yum install -y snapd
yum install -y wget
systemctl enable --now snapd.socket
ln -s /var/lib/snapd/snap /snap
snap wait system seed.loaded
systemctl restart snapd.seeded.service</p>
<h1 id="install-kubectl-and-helm">install kubectl and helm</h1>
<p>snap install kubectl --classic
snap install helm --classic</p>
</details>
<p>The nodes boot up and display their DHCP Address on login screen.
SSH to the nodes on port 22.
Default password is calltelemetry/calltelemetry</p>
<div class="admonition note">
<p class="admonition-title">It's OK to Change the password - it's not used anywhere else.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Change hostnames!</p>
<p>If you do not set the hostname per node, you will not get very far without things failing.</p>
</div>
<p>I recommend ct-node-1, ct-node-2, ct-node-3, etc, but this is your choice.
<div class="highlight"><pre><span></span><code>sudo hostnamect ct-node-1
</code></pre></div>
Repeat for other nodes 2 and 3.</p>
<h3 id="static-ip-the-nics-is-recommended">Static IP the NICs is recommended.</h3>
<p>in CentOS you can static the NICs like this
<div class="highlight"><pre><span></span><code>sudo nmtui
</code></pre></div></p>
<h1 id="install-first-k3s-master-node">Install First K3s Master Node</h1>
<p>Time: about 2 minutes
Copy and paste this via SSH on the first node.</p>
<div class="highlight"><pre><span></span><code>export INSTALL_K3S_CHANNEL=stable
export K3S_KUBECONFIG_MODE=&quot;0644&quot;
export K3S_TOKEN=&quot;calltelemetry&quot;
curl -sfL https://get.k3s.io | sh -s server --cluster-init --no-deploy traefik --disable servicelb
rm -rf .kube
mkdir .kube
sudo cat /etc/rancher/k3s/k3s.yaml &gt; ~/.kube/config
</code></pre></div>
<h1 id="install-k3s-masters-2-and-3">Install K3s Masters 2 and 3</h1>
<p>Time: about 5 minutes</p>
<div class="admonition note">
<p class="admonition-title">Change the K3S_URL IP address to Master node 1's IP Address</p>
</div>
<div class="highlight"><pre><span></span><code>export K3S_URL=&quot;https://192.168.123.167:6443&quot;
export INSTALL_K3S_CHANNEL=stable
export K3S_TOKEN=&quot;calltelemetry&quot;
export K3S_KUBECONFIG_MODE=&quot;0644&quot;
curl -sfL https://get.k3s.io | sh -s server - --no-deploy traefik --disable servicelb
rm -rf .kube
mkdir .kube
sudo cat /etc/rancher/k3s/k3s.yaml &gt; ~/.kube/config
sudo cat /var/lib/rancher/k3s/server/node-token
</code></pre></div>
<p>Check the health of the nodes before continuing - all should say running.</p>
<div class="highlight"><pre><span></span><code>calltelemetry@hp-k3s-1:~$ kubectl get nodes
NAME       STATUS   ROLES                       AGE     VERSION
ct-node-1   Ready    control-plane,etcd,master   4m36s   v1.20.0+k3s2
ct-node-2   Ready    control-plane,etcd,master   40s     v1.20.0+k3s2
ct-node-3   Ready    control-plane,etcd,master   19s     v1.20.0+k3s2
calltelemetry@hp-k3s-1:~$
</code></pre></div>
<h1 id="install-metallb-scale-dns-pods-and-traefik-proxy">Install MetalLB, Scale DNS Pods, and Traefik Proxy</h1>
<p>Time: about 5 minutes
Copy and Paste this block
<div class="highlight"><pre><span></span><code>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/namespace.yaml
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/metallb.yaml
kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey=&quot;$(openssl rand -base64 128)&quot;
kubectl scale deployment.v1.apps/coredns --replicas=3 -n kube-system
helm repo add traefik https://helm.traefik.io/traefik
helm repo update
helm install traefik traefik/traefik --set service.annotations.&quot;metallb\.universe\.tf\/address-pool&quot;=default
kubectl create namespace pgo
kubectl apply -f https://raw.githubusercontent.com/CrunchyData/postgres-operator/v4.5.1/installers/kubectl/postgres-operator.yml
curl https://raw.githubusercontent.com/CrunchyData/postgres-operator/v4.5.1/installers/kubectl/client-setup.sh &gt; client-setup.sh
chmod +x client-setup.sh
cat &lt;&lt;EOF &gt;&gt; ~/.bashrc
export PGOUSER=&quot;${HOME?}/.pgo/pgo/pgouser&quot;
export PGO_CA_CERT=&quot;${HOME?}/.pgo/pgo/client.crt&quot;
export PGO_CLIENT_CERT=&quot;${HOME?}/.pgo/pgo/client.crt&quot;
export PGO_CLIENT_KEY=&quot;${HOME?}/.pgo/pgo/client.key&quot;
export PGO_APISERVER_URL=&#39;https://127.0.0.1:8443&#39;
export PGO_NAMESPACE=pgo
EOF
source ~/.bashrc
</code></pre></div></p>
<p>In about 3-5 minutes, all pods in the cluster should be "Running"
<div class="highlight"><pre><span></span><code>[calltelemetry@ct-node-1 ~]$ kubectl get pod -A
NAMESPACE        NAME                                      READY   STATUS      RESTARTS   AGE
default          traefik-99bfb8458-9wjnc                   1/1     Running     0          2m37s
kube-system      coredns-854c77959c-6nf88                  1/1     Running     0          2m59s
kube-system      coredns-854c77959c-cg9vg                  1/1     Running     0          8m10s
kube-system      coredns-854c77959c-g9jbr                  1/1     Running     0          2m59s
kube-system      local-path-provisioner-7c458769fb-hpk77   1/1     Running     0          8m10s
kube-system      metrics-server-86cbb8457f-lfswr           1/1     Running     0          8m10s
metallb-system   controller-65db86ddc6-fmnvv               1/1     Running     0          2m59s
metallb-system   speaker-j4xj5                             1/1     Running     0          2m59s
metallb-system   speaker-k84ln                             1/1     Running     0          2m59s
metallb-system   speaker-lrmj9                             1/1     Running     0          2m59s
pgo              pgo-deploy-clz5l                          0/1     Completed   0          2m36s
pgo              postgres-operator-7b94775688-dv6nm        4/4     Running     1          83s
[calltelemetry@ct-node-1 ~]$
</code></pre></div></p>
<div class="admonition warning">
<p class="admonition-title">Wait for postgres-operator to be running before continue</p>
</div>
<h1 id="deploy-sql-ha-with-2-replicas">Deploy SQL HA with 2 Replicas</h1>
<p>Time: About 5 minutes</p>
<h2 id="run-sql-the-setup-script">Run SQL the Setup Script</h2>
<p>(Run this on Node 1) Leave this window open after running the port-forward.
You will have 2 windows open to Node 1.
<div class="highlight"><pre><span></span><code>./client-setup.sh
sudo mv .pgo/pgo/pgo /usr/local/bin
kubectl port-forward -n pgo svc/postgres-operator 8443:8443
</code></pre></div></p>
<h2 id="open-a-ssh-window-to-the-same-node-in-a-new-window">Open a SSH window to the same node in a NEW window</h2>
<div class="admonition note">
<p class="admonition-title">You can change the SQL password here if you like.</p>
</div>
<div class="highlight"><pre><span></span><code>pgo create cluster -n pgo ctsql -d calltelemetry_prod --replica-count 2 --password-superuser=calltelemetry
</code></pre></div>
<p>Check the status of the deployment by watching the pods deploy.</p>
<p><div class="highlight"><pre><span></span><code>kubectl get pods -n pgo

NAME                                          READY   STATUS              RESTARTS   AGE
ctsql-6895cd4bb-2f524                         0/1     ContainerCreating   0          21s
ctsql-backrest-shared-repo-7d4648f796-wxrqh   1/1     Running             0          32s
pgo-deploy-fpcq2                              0/1     Completed           0          3m27s
postgres-operator-7b94775688-2sf4c            4/4     Running             1          2m14s
</code></pre></div>
You should see 3 ctsql instances complete. Let's confirm they are online</p>
<div class="highlight"><pre><span></span><code>kubectl get pods -n pgo

NAME                                          READY   STATUS      RESTARTS   AGE
backrest-backup-ctsql-gnbvl                   0/1     Completed   0          57s
ctsql-6895cd4bb-2f524                         1/1     Running     0          118s
ctsql-backrest-shared-repo-7d4648f796-wxrqh   1/1     Running     0          2m9s
ctsql-iulc-75ccc767c7-wwd2k                   0/1     Running     0          49s
ctsql-stanza-create-tkltr                     0/1     Completed   0          66s
ctsql-yzgz-8689bb9998-c2mlf                   0/1     Running     0          49s
pgo-deploy-fpcq2                              0/1     Completed   0          5m4s
postgres-operator-7b94775688-2sf4c            4/4     Running     1          3m51s

# Check your Cluster

pgo test ctsql

cluster : ctsql
    Services
        primary (10.43.222.74:5432): UP
        replica (10.43.246.172:5432): UP
    Instances
        primary (ctsql-6895cd4bb-2f524): UP
        replica (ctsql-iulc-75ccc767c7-wwd2k): UP
        replica (ctsql-yzgz-8689bb9998-c2mlf): UP
</code></pre></div>
<h1 id="deploy-calltelemetry">Deploy CallTelemetry</h1>
<p>Time: About 2 minutes
Copy and paste this into a text editor, edit it with your password if you changed it, and assign 2 static IPS for primary and secondary. Cluster IP start and end are not use for CallTelemetry, but helpful to be set.</p>
<p>This step creates a ct_values.yaml file in the local folder. Edit it on the server or in notepad.
Paste this directly into the shell.
<div class="highlight"><pre><span></span><code>cat &lt;&lt;EOF &gt; ct_values.yaml
# ct_values.yaml
db_password: calltelemetry
primary_ip: 192.168.123.135
secondary_ip: 192.168.123.136
cluster_ip_start: 192.168.123.138
cluster_ip_end: 192.168.123.140
EOF
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>helm repo add ct_charts https://storage.googleapis.com/ct_charts/
helm repo update
helm install calltelemetry ct_charts/calltelemetry -f ct_values.yaml
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">If you need to re-deploy new values, it is an upgrade instead - like this</p>
</div>
<div class="highlight"><pre><span></span><code>helm upgrade calltelemetry -f ct_values.yaml
</code></pre></div>
<p>Check the deployment - you should see 3 CallTelemetry-web servers running.</p>
<div class="highlight"><pre><span></span><code>kubectl get pods

NAME                      READY   STATUS    RESTARTS   AGE
calltelemetry-web-fqlv5   1/1     Running   0          4m21s
calltelemetry-web-gp2f9   1/1     Running   0          4m21s
calltelemetry-web-zbkk6   1/1     Running   0          4m21s
svclb-traefik-4ngn8       2/2     Running   0          16m
svclb-traefik-6pmjw       2/2     Running   0          16m
svclb-traefik-chqsw       2/2     Running   0          16m
traefik-99bfb8458-8xdvj   1/1     Running   0          16m
</code></pre></div>
<p>Check your IPs assigned, you should see your IPs listed here
<div class="highlight"><pre><span></span><code>kubectl get services

NAME                      TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)                      AGE
calltelemetry-primary     LoadBalancer   10.43.195.226   192.168.123.135   80:30609/TCP,22:32207/TCP    13m
calltelemetry-secondary   LoadBalancer   10.43.122.52    192.168.123.136   80:32049/TCP,22:32124/TCP    13m
kubernetes                ClusterIP      10.43.0.1       &lt;none&gt;            443/TCP                      2d18h
traefik                   LoadBalancer   10.43.171.164   192.168.123.139   80:31050/TCP,443:30731/TCP   22h
</code></pre></div></p>
<p>Setup DNS records to point to your 2 IP Addresses - primary and secondary.
Open a web browser to http://primary-ip and create an account.</p>
<p>Use these 2 records for the CURRI API, and the primary for the CDR desintation.</p>
<h1 id="appendix-troubleshooting">Appendix / Troubleshooting</h1>
<h2 id="if-you-need-to-find-your-sql-password">If you need to find your SQL Password</h2>
<p>In our case, the password for postgres user is calltelemetry</p>
<div class="highlight"><pre><span></span><code>pgo show user -n pgo ctsql --show-system-accounts

CLUSTER USERNAME    PASSWORD                 EXPIRES STATUS ERROR
------- ----------- ------------------------ ------- ------ -----
ctsql   crunchyadm                           never   ok
ctsql   postgres    calltelemetry            never   ok
ctsql   primaryuser random_pass never   ok
ctsql   testuser    random_pass never   ok
</code></pre></div>
<h2 id="sql-crunchy-data-postgresql-operator">SQL - Crunchy Data PostgreSQL Operator</h2>
<p><a href="https://github.com/CrunchyData/postgres-operator">Cruncy Data PostgreSQL Operator Github</a></p>
<p><a href="https://access.crunchydata.com/documentation/postgres-operator/4.5.1/">Crunch Data PostgreSQL Operator Docs</a></p>
<p><a href="https://access.crunchydata.com/documentation/postgres-operator/4.5.1/quickstart/">Cruncy Data PostgreSQL Quickstart</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../ova/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                OVA Appliance
              </div>
            </div>
          </a>
        
        
          <a href="../../setup/curri/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Call Control
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2021 CallTelemetry
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ['navigation.tabs'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>